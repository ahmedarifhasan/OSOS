<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <link rel="stylesheet" href="/css/dashboard.css">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <link rel='stylesheet' type='text/css' href='https://api.tomtom.com/maps-sdk-for-web/cdn/5.x/5.64.0/maps/maps.css'>
    <script src="https://api.tomtom.com/maps-sdk-for-web/cdn/5.x/5.64.0/maps/maps-web.min.js"></script>
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBmvHghx_AzQJY36ufJoM4k-Yt_FI8NyfU&callback=initMap&libraries=&v=weekly"
        defer></script>
    <!-- Gmaps.js Import -->
    <script src="/scripts/gmaps.js"></script>


    <!-- TomTom Import -->
    <script src="/scripts/tomtom.js"></script>
    <link rel='stylesheet' type='text/css' href='https://api.tomtom.com/maps-sdk-for-web/cdn/5.x/5.64.0/maps/maps.css'>
    <script src="https://api.tomtom.com/maps-sdk-for-web/cdn/5.x/5.64.0/maps/maps-web.min.js"></script>





    <script src="/js/jquery.js"></script>
    <script src="/js/bootstrap.min.js"></script>

    <!-- There's a reason why I didn't use 'express-ejs-layouts' -->
    <script src="/js/bootstrap.js"></script>
    <script src="/js/jquery-1.8.3.min.js"></script>
    <script src="/js/jquery.dashboard.js"></script>

    <link rel="stylesheet" href="/css/bootstrap.css">

    <!--Animation css-->
    <link href="/css/animate.css" rel="stylesheet">
    <!-- js placed at the end of the document so the pages load faster -->
    <script src="/js/modernizr.min.js"></script>
    <script src="/js/pace.min.js"></script>
    <script src="/js/wow.min.js"></script>
    <script src="/js/jquery.scrollTo.min.js"></script>
    <script src="/js/jquery.nicescroll.js" type="text/javascript"></script>

    <!-- Counter-up -->
    <script src="/js/waypoints.min.js" type="text/javascript"></script>
    <script src="/js/jquery.counterup.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        jQuery(document).ready(function ($) {
            $('.counter').counterUp({
                delay: 100,
                time: 1200
            });
        });
    </script>

    <!--Icon-fonts css-->
    <link href="/css/style.css" rel="stylesheet">
    <link href="/css/helper.css" rel="stylesheet">
</head>

<body>
    <nav>
        <a href="#">
            <h1
                style="margin-top: 30px; margin-left: 20px; color: rgb(0, 0, 0); font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;">
                OrderBucket
            </h1>
        </a>
    </nav>

    <div class="container" style="margin-top: 15px;">


        <h2 style="font-weight: bolder;">Welcome <%= userdata.username %> , Click below to see the corresponding
            location on map</h2>
        <h4 class="alert alert-warning"> If your location doesn't match with that of the map click Update Location </h4>
        <button class="btn btn-danger btn-lg" onclick="updateLocation()">Update Location</button>
        <hr>
        <h4 style="display:inline-block"
            onclick="tomtom('<%= userdata.coordinates[1] %>','<%= userdata.coordinates[0] %>');"
            id="<%= userdata._id %>">
            <div class="alert alert-success">
                Your Address
            </div>
        </h4>
        <% data.forEach( (item) => { %>
        <span style="color: black;">
            &nbsp; |
        </span>
        <h4 style="display:inline-block" onclick="tomtom('<%= item.coordinates[1] %>','<%= item.coordinates[0] %>');
                // curr('<%= item.coordinates[0] %>','<%= item.coordinates[1] %>')
                " id="<%= item._id %>">
            <div class="alert alert-info">
                <%= item.username %>
            </div>
        </h4>
        <%}) %>


        <hr>

        <button id="button" onclick="addEL()" class="btn btn-lg btn-primary">
            Show Map
        </button>

        <div class="container-fluid" id="mp" style="display: none; margin-top: 10px;">
            <div class="row">
                <div class="col">
                    <div id="map2" style="border: 3px solid black; width: 100%; height: 50%;">

                    </div>
                </div>
            </div>
        </div>
        <hr>

        <button class="btn btn-dark btn-block btn-lg">
            Dummy Order
        </button>
        <hr>
        <button id="userLocationButton" type="button" onclick="getLocation()" class="btn btn-dark btn-block btn-lg">
            Get Your Location   
        </button>


        <h4>
            Your Location :

            <div style="display:inline-block;" id="userLocationlat">

            </div>
            <span>,</span>
            <div style="display: inline-block;" id="userLocationlong">

            </div>
        </h4>
        <div style="display: none;" class="lds-spinner" id="spinner">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>



    </div>


    <!-- TomTom Script -->
    <script>
        function tomtom(latitude, longitude) {

            latitude = Number(latitude)
            longitude = Number(longitude)

            console.log(latitude, longitude, "<<In TomTom f(x)>>");

            let coords = [],
                mapZoom = 11
            coords.push(latitude, longitude)

            console.log(coords, "<<<In cords >>");


            var map = tt.map({
                key: "h7Zirz3PBI0aDIrfq0UQlnOXm7HiB5kj",
                container: "map2",
                style: "tomtom://vector/1/basic-main",
                // Opp -> long , lat
                center: coords,
                zoom: mapZoom
            });
            map.addControl(new tt.FullscreenControl());
            map.addControl(new tt.NavigationControl());

            createMarker('/assets/red.jpg', coords, 'rgb(139,0,0)', 'Car Park');

            function createMarker(icon, position, color, popupText) {
                var markerElement = document.createElement('div');
                markerElement.className = 'marker';
                var markerContentElement = document.createElement('div');
                markerContentElement.className = 'marker-content';
                markerContentElement.style.backgroundColor = color;
                markerElement.appendChild(markerContentElement);
                var iconElement = document.createElement('div');
                iconElement.className = 'marker-icon';
                iconElement.style.backgroundImage =
                    'url(https://api.tomtom.com/maps-sdk-for-web/5.x/assets/images/' + icon + ')';
                markerContentElement.appendChild(iconElement);
                var popup = new tt.Popup({
                    offset: 30
                }).setText(popupText);
                // add marker to map
                new tt.Marker({
                        element: markerElement,
                        anchor: 'bottom'
                    })
                    .setLngLat(position)
                    .setPopup(popup)
                    .addTo(map);
            }

        }


        // Script for Toggle Map Button
        let map2 = document.getElementById("mp")
        let button = document.getElementById("button")

        function addEL() {
            if (map2.style.display == "none") {
                map2.style.display = "block"
            } else {
                map2.style.display = "none"
            }
            button.innerHTML = 'Toggle Map';
        }
        // Script for GeoLocation

        function getLocation() {
            // alert("Allow Location. If that does not work, Kindly Check your browser Settings and Try Again.")
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition);
            }
        }

        function showPosition(position) {
            document.getElementById("spinner").style.display = "block";
            setTimeout(() => {
                // document.getElementById("spinner").innerHTML = ('<h2>Loading...</h2>')
                console.log("in Settimeout");
                var lat = position.coords.latitude;
                var long = position.coords.longitude;
                document.getElementById("spinner").style.display = "none";

                // Get Current Location of the Customer
                document.getElementById('userLocationButton').style.display = "none"
                document.getElementById('userLocationlat').innerHTML = lat
                document.getElementById('userLocationlong').innerHTML = long
            }, 3000)

        }
    </script>
</body>

<script>
    function updateLocation(){
        getLocation();
    }
    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition);
        }
    }

    function showPosition(position) {
        var lat = position.coords.latitude;
        var long = position.coords.longitude;
        var data = {
            lat : lat,
            long : long
        }
        console.log(data , "In dashboard");
        $.post('/user/dashboard/'+ '<%=userdata._id%>' ,data,(data,status)=>{
        });
}
</script>

<style>
    body {
        background-color: rgb(190, 202, 253);
        font-weight: bolder;
        font-size: xx-large;
        font-family: monospace;
    }

    h3:hover {
        color: rgb(41, 39, 46);
        cursor: progress;
    }

    .lds-spinner {
        color: official;
        display: inline-block;
        position: relative;
        width: 80px;
        height: 80px;
    }

    .lds-spinner div {
        transform-origin: 40px 40px;
        animation: lds-spinner 1.2s linear infinite;
    }

    .lds-spinner div:after {
        content: " ";
        display: block;
        position: absolute;
        top: 3px;
        left: 37px;
        width: 6px;
        height: 18px;
        border-radius: 20%;
        background: #cef;
    }

    .lds-spinner div:nth-child(1) {
        transform: rotate(0deg);
        animation-delay: -1.1s;
    }

    .lds-spinner div:nth-child(2) {
        transform: rotate(30deg);
        animation-delay: -1s;
    }

    .lds-spinner div:nth-child(3) {
        transform: rotate(60deg);
        animation-delay: -0.9s;
    }

    .lds-spinner div:nth-child(4) {
        transform: rotate(90deg);
        animation-delay: -0.8s;
    }

    .lds-spinner div:nth-child(5) {
        transform: rotate(120deg);
        animation-delay: -0.7s;
    }

    .lds-spinner div:nth-child(6) {
        transform: rotate(150deg);
        animation-delay: -0.6s;
    }

    .lds-spinner div:nth-child(7) {
        transform: rotate(180deg);
        animation-delay: -0.5s;
    }

    .lds-spinner div:nth-child(8) {
        transform: rotate(210deg);
        animation-delay: -0.4s;
    }

    .lds-spinner div:nth-child(9) {
        transform: rotate(240deg);
        animation-delay: -0.3s;
    }

    .lds-spinner div:nth-child(10) {
        transform: rotate(270deg);
        animation-delay: -0.2s;
    }

    .lds-spinner div:nth-child(11) {
        transform: rotate(300deg);
        animation-delay: -0.1s;
    }

    .lds-spinner div:nth-child(12) {
        transform: rotate(330deg);
        animation-delay: 0s;
    }

    @keyframes lds-spinner {
        0% {
            opacity: 1;
        }

        100% {
            opacity: 0;
        }
    }

    .alert:hover {
        cursor: pointer;
        ;
    }
</style>

</html>